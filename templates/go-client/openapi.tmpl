package {{ index .GetMetadata "package" }}

import (
    "context"
	"errors"
	"net/http"
	"net/url"
	"strings"

 	"github.com/go-playground/validator/v10"
)

// ClientService is the interface for Client methods
type ClientService interface {
    {{- range $pathName, $path := .Paths }}
    {{- range $name, $operation := $path.Operations }}
    {{ $operation.GetName | SanitiseName }}(context.Context, *{{ $operation.GetName | SanitiseName }}Parameters, *{{ $operation.RequestBody.GetName | SanitiseName }}) ([]byte, error)
    {{- end }}
    {{- end }}
}

var _ ClientService = &Client{}

// AuthFunc needs to be passed in as a closure at client generation and allows for authentication to be applied to any
// request being made. It should contain any logic and data needed to apply and maintain authentication with a server.
type AuthFunc func(*http.Request) error

type Config struct {
	Port string
	Host string `validate:"required,hostname"` // Hostname RFC 952
	Protocol string `validate:"required"`
	ContentType string `validate:"required"`
}

type Client struct {
    *http.Client

    cfg *Config
	auth AuthFunc
}

func (c *Client) createUrl(pathPattern string, vals url.Values) url.URL {
	return url.URL{
		Scheme:   c.cfg.Protocol,
		Host:     c.cfg.Host + c.cfg.Port,
		Path:     pathPattern,
		RawQuery: vals.Encode(),
	}
}

// NewHTTPClient will create a new client with the given configuration and authentication function. It will perform
// validation on the contents of the config and throw an error if config contents prove to be invalid or the auth
// function is missing.
func NewHTTPClient(cfg *Config, af AuthFunc) (*Client, error) {
    if cfg == nil {
          return nil, errors.New("cannot start client without config")
    }
    if af == nil {
          return nil, errors.New("cannot start client without auth function")
    }
	if cfg.Protocol == "" && strings.Contains(cfg.Host, "://") {
		split := strings.Split(cfg.Host, "://")
		cfg.Host = split[1]
		cfg.Protocol = split[0]
	}
    validate := validator.New()
    if err := validate.Struct(cfg); err != nil {
        return nil, err
    }
    return &Client{
        Client: http.DefaultClient,
        cfg: cfg,
        auth: af,
    }, nil
}
